--- 
title: "Research on Fetal Deaths"
author: "Jiayi Yuan (jy3162) & Yayun Luo (yl4832)"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

```{r}
#install.packages("bookdown")
browseURL("docs/index.html")
```

![](infant.png)

The fetal mortality rate is the measure of poor reproductive health outcomes. It also indicates, to some extent, a country's medical and health level, economic level, and basic implementation level. As the most advanced developed country in the world, the United States is famous for its advanced medical technology and strong economic strength. However, the United States ranks very high in fetal mortality. The fetal mortality rate in the United States is even three times that of some developed countries (such as Japan and Sweden), which shows that fetal mortality is a serious issue that needs to be taken seriously.

We believe that the death of a fetal is not only a sad tragedy for the family but also has a very negative impact on an Aging American society. Therefore, in this project, we aim to explore the causes of fetal death. We will analyze the distribution of fetal mortality in the United States from the perspective of time and space. We will also examine whether specific fetal and parental characteristics contribute to fetal mortality. 

For more details of our project, please check out our [**GitHub repository**](https://github.com/MiraYuan/FetalDeath) or copy the following link https://github.com/MiraYuan/FetalDeath and paste it into your browser. 


<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

All of our datasets were downloaded from the [**CDC Wonder API—Fetal Deaths, 2005-2019 Request**](https://wonder.cdc.gov/controller/datarequest/D133) (https://wonder.cdc.gov/controller/datarequest/D133). Since CDC Wonder only provides limited numbers of *“group by”* options, we collected separate datasets to include all the variables we want to study from the API. 

## Dataset Documentation

Following is a brief introduction to the variables we studied:

**Maternal Residence: **

* State of mother's legal residence at the time of delivery

**Maternal and Parental Characteristics: **

* Mother's Race: American Indian or Alaska Native; Asian or Pacific Islander; Black or African American; White; Not Reported
* Age of Mother: classified by groups for under 15 years, and 5-year increments for 15 and older
* Age of Father: classified by groups for under 15 years, and 5-year increments for 15 and older, or not reported
* Mother's Marital Status: Married; Unmarried; Not Available

**Fetal Characteristics: **

* Year: Year of birth, 2005-2019
* Sex: Female, Male
* Delivery Weight: classfied by groups of 249 grams or less; 250 - 349 grams, 350 - 499 grams, 500 gram increments up to 4999 grams; 5000 - 8165 grams; unknown or not stated
* Plurality or Multiple Birth: Single; twin; triplet; quadruplet; quadruplet or higher; quintuplet or higher
* LMP Gestational Age: classified by groups for 20 - 23 weeks; 24 - 27 weeks; 28 - 31 weeks; 32 - 35 weeks; 36 weeks; 37-39 weeks; 39 weeks, 40 weeks; 41 weeks; 42 or more weeks; unknown; not available
* Delivery Method: Vaginal; cesarean; not stated; not reported
* Vacuum: Use of vacuum during delivery or not, or not available

**Congenital Anomalies of the Fetus:**

* Whether the fetus had congenital anencephalus, spina bifida/meningocele, omphalocele/gastroschisis, cleft lip/palate, downs syndrome or not, or not available

## Limitations
Even though CDC Wonder can provide reliable and authoritative data, there are still some limitations. Most of the variables in the interface *Fetal Deaths, 2005-2019 Request* we used are categorical variables, and there are only two continuous variables--*Year* and *Fetal Death* (or *Percent to Total Death*). The lack of numerical variables brought restrictions to our research. In addition, not being able to combine different datasets due to a lack of information may also decrease the multidimensionality between variables. However, since we still have various variables in each dataset to work on, this is not a big problem.



<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

Since we chose the features we would like to use when we collected our data, we do not need to do additional work in R to select the variables. What is more, thanks to CDC Wonder, all the data files we collected are already in the tidy version; we do not need to do too much work on transforming the data. CDC Wonder always renders the metadata in a *Note* column and a *codes* column for each variable. We believe these pieces of information are unnecessary, so we simply delete them to make our datasets more readable and save environmental space. What else we focused on was to figure out the values should be changed to missing values, for instance, values recorded as *unknown* or *not stated*.

<center>
![](baby_3.png)
</center>

```{r}
library(tidyr)
fetal <- read.delim("Fetal Deaths, 2005-2019.txt")
fetal <- fetal[,c(-1,-3,-5,-7,-9,-11)]
fetal <- na.omit(fetal)
fetal$Age.of.Mother.9 <- as.factor(fetal$Age.of.Mother.9)

fetal_2 <- read.delim("Fetal Deaths, 2005-2019 (1).txt") %>%
  dplyr::select(2,4,6,8,10,12,13)
fetal_2 <- fetal_2[1:3942,]
fetal_2 <- fetal_2 %>%
  dplyr::mutate(Infant.Delivery.Weight.14 = 
           ifelse(grepl("Not",Infant.Delivery.Weight.14, fixed = TRUE), NA_character_, Infant.Delivery.Weight.14)) %>%
  dplyr::mutate(LMP.Gestational.Age.10 = 
           ifelse(grepl("Not", LMP.Gestational.Age.10, fixed = TRUE), NA_character_, LMP.Gestational.Age.10)) %>%
  dplyr::mutate(Delivery.Method = 
           ifelse(grepl("Not", Delivery.Method, fixed = TRUE), NA_character_, Delivery.Method)) %>%
  dplyr::mutate(Plurality.or.Multiple.Birth = 
           ifelse(grepl("Not", Plurality.or.Multiple.Birth, fixed = TRUE),
                   NA_character_, Plurality.or.Multiple.Birth))

fetal_con <- read.delim("Fetal Deaths congential.txt") %>%
  dplyr::select(2,4,6,8,10,12,13)
fetal_con <- fetal_con[1:276,]
fetal_con <- fetal_con %>%
  dplyr::mutate(Anencephalus = ifelse(grepl("Not",Anencephalus, fixed = TRUE), NA_character_,
                               Anencephalus)) %>%
  dplyr::mutate(Spina.Bifida...Meningocele = 
                  ifelse(grepl("Not",Spina.Bifida...Meningocele, fixed = TRUE), NA_character_,
                         Spina.Bifida...Meningocele)) %>%
  dplyr::mutate(Omphalocele...Gastroschisis = 
                  ifelse(grepl("Not",Omphalocele...Gastroschisis, fixed = TRUE), NA_character_,
                         Omphalocele...Gastroschisis)) %>%
  dplyr::mutate(Cleft.Lip...Palate = 
                  ifelse(grepl("Not",Cleft.Lip...Palate, fixed = TRUE), NA_character_,
                         Cleft.Lip...Palate))

fetal_con_downs <- read.delim("Fetal Deaths congential downs.txt") %>%
  dplyr::select(2,4,6,7)
fetal_con_downs <- fetal_con_downs[1:185,]
fetal_con_downs <- fetal_con_downs %>%
  dplyr::mutate(Downs.Syndrome = ifelse(grepl("Not",Downs.Syndrome, fixed = TRUE), 
                                 NA_character_,Downs.Syndrome)) 

```








<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

The variables that do not have the categories of "not available" or "not stated" do not have any missing values. Therefore, we only checked the datasets with variables that have those categories.

## Fetal Characteristics Dataset

```{r}
library(redav)
plot_missing <- function(x, percent = TRUE) {	
  na_count_all <- data.frame(is.na(x)) %>%	
    dplyr::group_by_all() %>%	
    dplyr::count(name = "count", sort = TRUE) %>%	
    dplyr::ungroup() %>%	
    tibble::rownames_to_column("pattern")	
  
  na_count_all <- na_count_all %>% 
    dplyr::mutate(pattern = factor(.data$pattern, levels = nrow(na_count_all):1))
  
  # count the number of columns with missing values; will be used later to determine if there's a "none missing" pattern	
  na_count_all <- na_count_all %>% 	
    dplyr::rowwise() %>%	
    dplyr::mutate(num_missing_cols = sum(dplyr::c_across(where(is.logical))))	
  
  # data frame for missing patterns bar chart	
  na_count_by_pattern <- na_count_all[,c("pattern", "count", "num_missing_cols")]
  na_count_by_pattern$none_missing <- ifelse(na_count_by_pattern$num_missing_cols == 0, TRUE, FALSE)

  # data frame for missing by column bar chart	
  na_count_by_column <- data.frame(is.na(x)) %>%	
    colSums() %>% 	
    sort(decreasing = TRUE) %>% 	
    tibble::enframe(name = "var", value = "count")	
  
  # tidy and sort na_count_all by column counts	
  na_count_all_tidy <- na_count_all %>% 	
    tidyr::pivot_longer(where(is.logical), names_to = "variable") %>%	
    dplyr::mutate(variable = factor(.data$variable, levels = na_count_by_column$var))  %>% 	
    dplyr::mutate(none_missing = ifelse(.data$num_missing_cols == 0, TRUE, FALSE))	
  
  # main plot
  main_plot <- ggplot2::ggplot(na_count_all_tidy, 
                               ggplot2::aes(.data$variable,.data$pattern, 
                                            fill = factor(.data$value), 
                                            alpha = .data$none_missing)) +	
    ggplot2::geom_tile(color = "white") +	
    ggplot2::scale_fill_manual(values = c("grey70", "mediumpurple")) +	
    ggplot2::scale_alpha_manual(values = c(.7, 1)) +	
    ggplot2::ylab("missing pattern") +	
    ggplot2::guides(fill = "none", alpha = "none") +	
    ggplot2::theme_classic(12) +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, size=7))
  
  # check for "none missing" pattern
  none_missing_pattern <- na_count_by_pattern %>%
    dplyr::filter(.data$none_missing) %>% dplyr::pull(.data$pattern)
  
  if (length(none_missing_pattern) > 0) {	
    main_plot <- main_plot +	
      ggplot2::annotate("text", x = (ncol(na_count_all)-2)/2,	
               y = nrow(na_count_all) + 1 - as.numeric(as.character(none_missing_pattern)),	
               label = "complete cases")	
  }	
  
  # margin plots
  
  denom <- ifelse(percent, nrow(x)/100, 1)
  
  missing_by_column_plot <- ggplot2::ggplot(na_count_by_column,
                                            ggplot2::aes(forcats::fct_inorder(.data$var),
                                                         .data$count/denom)) +	
    ggplot2::geom_col(fill = "cornflowerblue", alpha = .7) +
    ggplot2::scale_y_continuous(expand = c(0, 0), n.breaks = 3) +	
    ggplot2::xlab("") +
    ggplot2::ylab(ifelse(percent, "% rows \n missing:", "num rows \n missing:")) +	
    ggplot2::theme_linedraw(12) + 	
    ggplot2::theme(panel.grid.major.x = ggplot2::element_blank(),	
          panel.grid.minor.x = ggplot2::element_blank(),
          axis.text.x = ggplot2::element_text(angle = 90, size=7))	
  
  missing_by_pattern_plot <- 
    ggplot2::ggplot(na_count_by_pattern, 
                    ggplot2::aes(.data$pattern, .data$count/denom, 
                                 alpha = .data$none_missing)) +
    ggplot2::geom_col(fill = "cornflowerblue") +
    ggplot2::coord_flip() +
    ggplot2::scale_y_continuous(expand = c(0, 0), n.breaks = 3) +
    ggplot2::scale_alpha_manual(values = c(.7, 1)) +
    ggplot2::xlab("") +
    ggplot2::ylab(ifelse(percent, "% rows", "row count")) +
    ggplot2::guides(alpha = "none") +
    ggplot2::theme_linedraw(12) +
    ggplot2::theme(panel.grid.major.y = ggplot2::element_blank(), 
          panel.grid.minor.y = ggplot2::element_blank())
  
  if (percent) {	
    missing_by_column_plot <- missing_by_column_plot +
      ggplot2::scale_y_continuous(expand = c(0, 0), n.breaks = 5,
                         limits = c(0, 100))	
    missing_by_pattern_plot <- missing_by_pattern_plot +
      ggplot2::scale_y_continuous(expand = c(0, 0), n.breaks = 5,
                         limits = c(0, 100))	
  }
  
  #par(mfrow = c(2, 2))
  list(main_plot, missing_by_column_plot, missing_by_pattern_plot)
  missing_by_column_plot + patchwork::plot_spacer() +
    main_plot + missing_by_pattern_plot +
    patchwork::plot_layout(widths = c(4, 1), heights = c(1, 4))
 }

#utils::globalVariables("where")
```

```{r comment=NA}
plot_missing(fetal_2)
```

As we can see from the graphs, most rows in the dataset we used to study fetal characteristics do not have any missing values, and only a tiny part of the rows miss more than two variables. We can notice that, from most to least, the missed variables are *LMP Gestational Age*, *Infant Delivery Weight* and *Delivery Method*. We think the miss of this data was because of difficulties of documenting, unnecessary of recording, or informality of the delivery places.

## Congenital Anomalies Dataset

```{r}
plot_missing(fetal_con)
```

By checking the missing patterns of the dataset we used to study fetuses' congenital anomalies, we notice that there are only two situations: complete cases and miss of all congenital anomalies data. Even though more than 25% of rows missed all congenital data, it was because the variables were recorded as "Not stated" and "Not available," which doubled the number of *NA* values. Since we focused on each congenital anomaly separately, we do not need to worry too much about the rows that missed all the data.


<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

## Fetal Deaths Over Years
```{r}
library(ggplot2)
library(dplyr)
library(plotly)

### Total
g1 <- fetal %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(add = sum(Fetal.Deaths), add_p = sum(Percent.of.Total.Deaths)) %>%
  ggplot(aes(x = Year, y = add_p)) +
  geom_line() +
  geom_point(alpha = 0.5) +
  geom_point(aes(x = 2007, y = 7.22), color = "red") +
  geom_text(aes(label = add_p), nudge_x = 0.4, nudge_y = -0.06, size = 3) +
  labs(x = "Year", y = "Total Fetal Death Rate",
       title = "Fetal Death Rate Over Years") +
  scale_x_continuous(breaks = seq(2005, 2019, 1))
g1


g2 <- fetal %>%
  dplyr::group_by(Sex, Year) %>%
  dplyr::summarise(add_g = sum(Fetal.Deaths), add_g_p = sum(Percent.of.Total.Deaths)) %>%
  ggplot(aes(x = Year, y = add_g_p, col = Sex)) +
  geom_line() +
  geom_point(alpha = 0.5) +
  labs(x = "Year", y = "Fetal Death Rate",
       title = "Fetal Death Rate by Different Genders Over Years") +
  scale_x_continuous(breaks = seq(2005, 2019, 1))

start = 2007
end = 2008
g2 + annotate("rect", xmin = start, xmax = end, ymin = -Inf, ymax = Inf, 
              fill = "green", alpha = .2) +
  annotate("text", x = 2008.1, y = 3, label = "2007-2008", 
           color = "black", hjust = 0) +
  theme_classic()

# g3 <- birth_s_g %>%
#   group_by(Gender, Year) %>%
#   summarise(sum = sum(Births)) %>%
#   ggplot(aes(x = Year, y = sum, col = Gender)) +
#   geom_line() +
#   geom_point() +
#   labs(x = "Year", y = "Number of Births", 
#        title = "Number of Births by Different Genders Over Years") +
#   theme_classic() +
#   scale_x_continuous(breaks = seq(2007, 2019, 1))
# g3

# fetal %>%
#   group_by(Year) %>%
#   summarise(add = sum(Fetal.Deaths), add_p = sum(Percent.of.Total.Deaths)) %>%
#   plot_ly(x = ~Year, y = ~add, type = "scatter", mode = "lines+markers",
#           hoverinfo = "text", text = ~add) %>%
#   layout(title = "Total Fetal Deaths Over Years", 
#          xaxis = list(title = "Year", breaks = seq(2005, 2019, 1)),
#          yaxis = list(title = "Number of Total Death"))
```

First of all, let us take a look at how the fetal death rates changed between 2005 and 2019. We can clearly see a decreasing trend since 2007. Since we don’t have data before 2007, even though our graphs show there might be an increasing trend before 2007, we cannot simply make a conclusion. After further checking the movement by splitting the data into different genders, we found out that from 2007 to 2008, the female fetal death rate had a sharper decrease than male data did. We should notice that our graph shows higher death rates for male fetuses. This is not because male fetuses have a higher possibility of death but because male fetuses have higher birth rates in general. This decreasing trend is a good indicator, showing an improvement in national health. It is also unsurprising: with the development of technology and medical skills, we can now detect any potential factors that lead to fetus deaths more efficiently.

## Geographical Distribution
```{r}
#install.packages("rgdal",dependencies = TRUE)
library(choroplethrMaps)
library(choroplethr)
df_geo <- fetal_2 %>%
  dplyr::group_by(Standard.Residence.States) %>%
  dplyr::summarise(death = sum(Fetal.Deaths), death.p = sum(Percent.of.Total.Deaths)) %>%
  as.data.frame() %>%
  transmute(region = tolower(`Standard.Residence.States`), value = death.p)

state_choropleth(df_geo, title = "Contribution of Fetal Death to Total Death in US",
                 legend = "Percentage")
```


## Remarkable Fetal Characteristics

### Does Infant Weights matters?
```{r}
library(forcats)
fetal_2 %>% 
  na.omit() %>%
  dplyr::group_by(Infant.Delivery.Weight.14) %>%
  dplyr::summarise(add = sum(Percent.of.Total.Deaths)) %>%
  dplyr::arrange(add) %>%
  ggplot2::ggplot(aes(x = add, y = forcats::fct_reorder(Infant.Delivery.Weight.14,add))) +
  ggplot2::geom_point(color = "blue") +
  ggplot2::theme_linedraw() +
  ggplot2::ylab("Percent") +
  ggplot2::xlab("Infant Weight") +
  ggplot2::ggtitle("Percent of Total Deaths for Different Infant Weights")
```

### Relationships between delivery method and plurality of birth
```{r}
library(parcoords)
library(GGally)
library(ggalluvial)
df_alluvial <- fetal_2 %>%
  dplyr::group_by(Delivery.Method, Plurality.or.Multiple.Birth) %>%
  dplyr::summarise(total = sum(Percent.of.Total.Deaths)) %>%
  na.omit() 
ggplot(df_alluvial, aes(axis1 = Delivery.Method, axis2 = Plurality.or.Multiple.Birth, 
                        y = total)) +
  geom_alluvium(color = "black" ) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = paste(after_stat(stratum)))) +
  scale_x_discrete(limits = c("Delivery Method","Multiple Birth")) +
  ylab("Percentage to Total Death") +
  ggtitle("Flow of change between delivery method and plurality of birth")
```

```{r}
df_mosaic <- fetal_2 %>%
  dplyr::group_by(Delivery.Method,Plurality.or.Multiple.Birth) %>%
  dplyr::summarise(add = sum(Percent.of.Total.Deaths)) %>%
  na.omit()

df_mosaic$Plurality.or.Multiple.Birth <- factor(df_mosaic$Plurality.or.Multiple.Birth,
                                             levels = c("Single","Twin","Triplet"))
  

tab_mosaic <- xtabs(add~.,df_mosaic)

vcd::mosaic(Delivery.Method~Plurality.or.Multiple.Birth, tab_mosaic,
            direction = c("v","h"), set_labels=list(Plurality.or.Multiple.Birth 
                                                    = c("1", "2",">3")),
            gp_labels = grid::gpar(fontsize = 8), highlighting_fill = c("#D1E5F0","#2166AC"),
            main = "Delivery Method vs. Multiple Birth Number")
  
```

### LMP weeks
```{r}
df_bar <- fetal_2 %>%
  dplyr::group_by(LMP.Gestational.Age.10) %>%
  dplyr::summarise(add = sum(Percent.of.Total.Deaths)) %>%
  dplyr::arrange(desc(add)) %>%
  na.omit()

ggplot(data = df_bar,aes(x = reorder(LMP.Gestational.Age.10,add), y=add)) +
  geom_bar(stat = "identity",fill = "cornflowerblue") +
  ggtitle("LMP Gestational Age Distribution") +
  xlab("LMP Gestational Age") +
  ylab("Percent to Total Death") +
  coord_flip() +
  theme(panel.grid.major.x = element_blank())
```



## Maternal/Paternal Characteristics

```{r}
library(tidyverse)
library(ggplot2)
parentsAge <- read.delim("parentsAge.txt") %>% 
  dplyr::select(Age.of.Mother.9, Age.of.Father,Fetal.Deaths) %>%
  dplyr::filter(Age.of.Father != "" & Age.of.Father != "Unknown or Not Stated" & Age.of.Father != "Not Reported")
g_age <- ggplot(parentsAge, aes(x = Age.of.Father, y = Fetal.Deaths)) +
  geom_col(position = "dodge") +
  coord_flip() + 
  facet_wrap(~Age.of.Mother.9) + 
  ggtitle("Fetal Deaths Faceted by Maternal Age") + 
  xlab("Paternal Age") +
  ylab("# of Fetal Deaths")
print(g_age)
```

```{r}
race <- fetal %>% dplyr::select(Mother.s.Bridged.Race, Year, Fetal.Deaths) %>%
  filter(Mother.s.Bridged.Race != "Not Reported") %>%
  group_by(Mother.s.Bridged.Race, Year) %>%
  summarize(n = n())

library(ggridges)
g_race <- ggplot(race, aes(x = Year, y = Mother.s.Bridged.Race, fill = Mother.s.Bridged.Race)) +
  geom_density_ridges(aes(n)) +
  theme_ridges() + 
  theme(legend.position = "none") +
  ggtitle("")
print(g_race)
```





### Clevland plot

```{r}
library(dplyr)
library(ggplot2)
Race_N_Marriage <- read.delim("RaceNMarriage.txt") %>% 
  rename('Maternal_Race' = Mother.s.Bridged.Race) %>%
  rename('Maternal Marital Status' = Mother.s.Marital.Status) %>% 
  na.omit() %>%
  dplyr::select(`Maternal_Race`, `Maternal Marital Status`, Fetal.Deaths) %>%
  filter(`Maternal Marital Status` == "Married" | `Maternal Marital Status` == "Unmarried") %>%
  group_by(Maternal_Race,'Maternal Marital Status')

ggplot(Race_N_Marriage, aes(x = Maternal_Race, y = Fetal.Deaths, color = `Maternal Marital Status`)) +
  geom_point(size = 3) +
  coord_flip() +
#  facet_wrap(~Maternal Marital Status)+
  ylab("# of Fetal Deaths") +
  xlab("Maternal Race")
```


<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component

## The Total Amount of Fetal Death from 2005 to 2019

```{r}
library(dygraphs)
library(xts)          
library(tidyverse)
library(lubridate)

#data
fetal_by_year <- fetal %>% group_by(Year) %>%
  summarize(`Total Fetal Deaths` = sum(Fetal.Deaths))

#plot
g_by_year <- dygraph(fetal_by_year) %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors="#D8AE5A") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1) 
g_by_year
```


## Select Congenital Anomalies of The Fetus in US

```{r}
library(plotly)
#library(shiny)
###Downs
fetal_con_downs_new <- fetal_con_downs %>%
  group_by(Standard.Residence.States,Downs.Syndrome) %>%
  summarise(add = sum(Fetal.Deaths)) %>%
  filter(Downs.Syndrome=="Yes") %>%
  rename(State =Standard.Residence.States) %>%
  select(1,3)
not_include <- state.name[state.name %in% fetal_con_downs_new$State == FALSE]
bind <- data.frame(State =not_include,
                   add = rep(0, length(not_include)))
fetal_con_downs_new <- rbind(fetal_con_downs_new, bind)

## Trace only USA
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  lakecolor = toRGB('white')
)

percent <- fetal_con_downs_new$add
# downs_plot <- plot_geo() %>%
#   add_trace(
#     z = ~percent, text = state.name, span = I(1),
#     locations = state.abb, locationmode = 'USA-states', colors = "Blues"
#   ) %>%
#   layout(geo = g, title = "Fetuses Died With Congential Downs Syndrome in US") %>%
#   colorbar(title = "Fetal Death Number")
#downs_plot

###Anencephalus
m <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 4
)

fetal_con_ane <- fetal_con %>%
  group_by(Standard.Residence.States,Anencephalus) %>%
  summarise(add = sum(Fetal.Deaths)) %>%
  filter(Anencephalus == "Yes") %>%
  rename(State =Standard.Residence.States) %>%
  select(1,3)
not_include_ane <- state.name[state.name %in% fetal_con_ane$State == FALSE]
bind_ane <- data.frame(State =not_include_ane,
                   add = rep(0, length(not_include_ane)))
fetal_con_ane <- rbind(fetal_con_ane, bind_ane)

percent_ane <- fetal_con_ane$add
ane_plot <- plot_geo() %>%
  add_trace(
    z = ~percent_ane, text = state.name, span = I(1),
    locations = state.abb, locationmode = 'USA-states', colors = "Blues") %>%
  layout(geo = g, title = "Fetuses Died With Congential Anencephalus in US") %>%
  colorbar(title = paste("Fetal Death","<br>Number"))
#ane_plot

###Spina
fetal_con_spi <- fetal_con %>%
  group_by(Standard.Residence.States,Spina.Bifida...Meningocele) %>%
  summarise(add = sum(Fetal.Deaths)) %>%
  filter(Spina.Bifida...Meningocele == "Yes") %>%
  rename(State =Standard.Residence.States) %>%
  select(1,3)
not_include_spi <- state.name[state.name %in% fetal_con_spi$State == FALSE]
bind_spi <- data.frame(State =not_include_spi,
                   add = rep(0, length(not_include_spi)))
fetal_con_spi <- rbind(fetal_con_spi, bind_spi)

percent_spi <- fetal_con_spi$add
# spi_plot <- plot_geo() %>%
#   add_trace(
#     z = ~percent_spi, text = state.name, span = I(1),
#     locations = state.abb, locationmode = 'USA-states', colors = "Blues"
#   ) %>%
#   layout(geo = g, title = "Fetuses Died With Congential Spina Bifida or Meningocele in US") %>%
#   colorbar(title = "Fetal Death Number")
#spi_plot

###Omphalocele
fetal_con_omp <- fetal_con %>%
  group_by(Standard.Residence.States,Omphalocele...Gastroschisis) %>%
  summarise(add = sum(Fetal.Deaths)) %>%
  filter(Omphalocele...Gastroschisis == "Yes") %>%
  rename(State =Standard.Residence.States) %>%
  select(1,3)
not_include_omp <- state.name[state.name %in% fetal_con_omp$State == FALSE]
bind_omp <- data.frame(State =not_include_omp,
                   add = rep(0, length(not_include_omp)))
fetal_con_omp <- rbind(fetal_con_omp, bind_omp)

percent_omp <- fetal_con_omp$add
# omp_plot <- plot_geo() %>%
#   add_trace(
#     z = ~percent_omp, text = state.name, span = I(1),
#     locations = state.abb, locationmode = 'USA-states', colors = "Blues"
#   ) %>%
#   layout(geo = g, title = "Fetuses Died With Congential Omphalocele or Gastroschisis in US") %>%
#   colorbar(title = "Fetal Death Number")
#omp_plot

###Cleft lip
fetal_con_clf <- fetal_con %>%
  group_by(Standard.Residence.States,Cleft.Lip...Palate) %>%
  summarise(add = sum(Fetal.Deaths)) %>%
  filter(Cleft.Lip...Palate == "Yes") %>%
  rename(State =Standard.Residence.States) %>%
  select(1,3)
not_include_clf <- state.name[state.name %in% fetal_con_clf$State == FALSE]
bind_clf <- data.frame(State =not_include_clf,
                   add = rep(0, length(not_include_clf)))
fetal_con_clf <- rbind(fetal_con_clf, bind_clf)

percent_clf <- fetal_con_clf$add
# clf_plot <- plot_geo() %>%
#   add_trace(
#     z = ~percent_clf, text = state.name, span = I(1),
#     locations = state.abb, locationmode = 'USA-states', colors = "Blues"
#   ) %>%
#   layout(geo = g, title = "Fetuses Died With Congential Cleft Lip or Palate in US") %>%
#   colorbar(title = "Fetal Death Number")
#clf_plot

ane_plot %>%
  layout(title = "Distribution of Selected Congenital Anomalies in US",
  xaxis = list(domain = c(0.1, 1)),
  yaxis = list(title = "y"),
  updatemenus = list(
    list(
      y = 1,x=1,
      buttons = list(
        list(method = "restyle", args = list("z", list(percent_ane)),
             label = "Anencephalus"),
        list(method = "restyle", args = list("z", list(percent_spi)),
             label = paste("Spina Bifida/" , "<br>Meningocele")),
        list(method = "restyle", args = list("z", list(percent_omp)),
             label = paste("Omphalocele/","<br>Gastroschisis")),
        list(method = "restyle", args = list("z", list(percent_clf)),
             label = paste("Cleft Lip/","<br>Palate")),
        list(method = "restyle", args = list("z", list(percent)),
             label = paste("Downs","<br>Syndrome"))
      )
    )
  ))

```

## Changes in the Number of Fetal Deaths Among Different Maternal Ages in Different Years
```{r}
# install.packages("remotes")
# remotes::install_github("hrbrmstr/streamgraph")
library(streamgraph)
#library(tidyverse)

data <- fetal %>% group_by(Age.of.Mother.9, Year) %>% 
  summarise(Deaths = sum(Fetal.Deaths))
g_age_year <- streamgraph(data, key="Age.of.Mother.9", value="Deaths", date="Year") %>%
  sg_legend(show=TRUE, label="names: ")
g_age_year
```






<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

